<div class="p-6">
  <app-clients-filter-form
    (formValue$)="formValue$.next($event)"
  ></app-clients-filter-form>
  <div class="bg-white shadow rounded overflow-hidden">
    <div class="p-4 border-b">
      <h3 class="text-lg font-medium">Clients</h3>
    </div>
    <div class="overflow-x-auto">
      <table
        class="min-w-full divide-y divide-gray-200"
        [class.loading]="stream.pending$ | async"
      >
        <thead class="bg-gray-50">
          <tr>
            <th
              class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
            ></th>
            <th
              class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
            >
              Name
            </th>
            <th
              class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
            >
              Email
            </th>
            <th
              class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
            >
              Registered
            </th>
          </tr>
        </thead>
        @if (stream.error$ | async; as error) {
          <tbody>
            <tr>
              <td colspan="4">
                <app-generic-error
                  [showReload]="true"
                  (reload)="stream.reload()"
                ></app-generic-error>
              </td>
            </tr>
          </tbody>
        } @else {
          @if (stream.value$ | async; as value) {
            <tbody class="bg-white divide-y divide-gray-200">
              @for (client of value.data; track client.clientId) {
                <tr>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    <button
                      (click)="client.isExpanded.set(!client.isExpanded())"
                      [attr.aria-expanded]="client.isExpanded()"
                      class="p-1 rounded transition-colors duration-150"
                      [class.text-gray-500]="!client.isExpanded()"
                      [class.text-blue-600]="client.isExpanded()"
                      [class.bg-gray-100]="!client.isExpanded()"
                      [class.bg-blue-50]="client.isExpanded()"
                      title="Toggle details"
                    >
                      <!-- chevron icon rotates when expanded -->
                      <svg
                        class="w-4 h-4 transition-transform duration-150"
                        [class.rotate-180]="client.isExpanded()"
                        xmlns="http://www.w3.org/2000/svg"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                        aria-hidden="true"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M19 9l-7 7-7-7"
                        />
                      </svg>
                    </button>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    {{ client.name }}
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    {{ client.email }}
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    {{ client.registeredAt | date: "medium" }}
                  </td>
                </tr>
                @if (client.isExpanded()) {
                  <tr class="bg-gray-50">
                    <td colspan="4" class="px-6 py-4">
                      @if (
                        clientRequestFactory.get(client.clientId);
                        as clientDetails$
                      ) {
                        <app-stateful-block [stream]="clientDetails$">
                          @if (clientDetails$ | async; as clientDetails) {
                            <app-client-info
                              [displayData]="clientDetails"
                            ></app-client-info>
                          }
                        </app-stateful-block>
                      }
                    </td>
                  </tr>
                }
              }

              @if (!value.data.length) {
                <tr>
                  <td class="px-6 py-4 text-sm text-gray-500" colspan="3">
                    No results
                  </td>
                </tr>
              }
            </tbody>
          }
        }
      </table>
    </div>
    @if (pagination$ | async; as pagination) {
      <div
        [formGroup]="pagination"
        class="p-4 border-t flex items-center justify-between"
      >
        <div class="flex items-center space-x-2">
          <button
            class="px-3 py-1 bg-gray-100 rounded disabled:opacity-50"
            (click)="prevPage(pagination)"
            [disabled]="pagination.value.page === 1"
          >
            Prev
          </button>
          <button
            class="px-3 py-1 bg-gray-100 rounded disabled:opacity-50"
            (click)="nextPage(pagination)"
            [disabled]="
              pagination.value.page === (stream.value$ | async)?.totalPages
            "
          >
            Next
          </button>
        </div>
        <div class="flex items-center space-x-4">
          <div class="text-sm text-gray-600">
            Page:
            <span class="font-medium">{{
              pagination.controls.page.value
            }}</span>
          </div>
          <label class="text-sm text-gray-600"
            >Page size
            <select
              formControlName="pageSize"
              class="ml-2 rounded border-gray-300"
            >
              <option [value]="5">5</option>
              <option [value]="10">10</option>
              <option [value]="20">20</option>
            </select>
          </label>
          <div class="text-sm text-gray-600">
            Total pages:
            <span class="font-medium">{{
              (stream.value$ | async)?.totalPages || 0
            }}</span>
          </div>
        </div>
      </div>
    }
  </div>
</div>
